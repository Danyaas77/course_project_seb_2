# STRIDE Matrix

| Flow / Element | STRIDE class | Threat description | Risk / Priority | Controls & mitigations | NFR refs | Evidence / Quick win |
|----------------|--------------|--------------------|-----------------|------------------------|----------|----------------------|
| F1 — Secrets provisioning (`APP_API_KEY`) | Spoofing / Tampering | Перехват или подмена ключа при передаче владельцу. | R1 — High | Ключ генерируется офлайн, хранится в password manager, `.env` в `.gitignore`, ежеспринтовая ротация. | NFR-SC-3 | `.env.example`, onboarding guide. |
| F2 — Secret mount в контейнер | Tampering | Инъекция фальшивого ключа/конфигурации при деплое. | R2 — High | Secret store с RBAC, deploy pipeline имеет read-only доступ; валидация на старте (fail-fast при отсутствии ключа). | NFR-SC-3, NFR-SDLC-1 | `app/main.py:214`, deployment docs. |
| F3 — HTTPS запросы клиентов | Spoofing | Подмена `X-API-Key`, повторное использование трафика. | R2 — High | `require_api_key` + `secrets.compare_digest`, HTTPS mandatory, correlation_id логируется. | NFR-SC-1 | `app/main.py:214`, `tests/test_items_security.py`. |
| F3 — Payload tampering (`/users`, `/chores`, `/assignments`) | Tampering / Elevation | Внедрение недопустимых cadence/status, отриц. due_at. | R3 — Medium | Pydantic модели + кастомные валидаторы (trim, enums, timezone). | NFR-VAL-1, NFR-SC-2 | `app/main.py:244-360`, `tests/test_chores_assignments.py`. |
| F3 — DoS via burst traffic | DoS | Скрипт перегружает API тысячами запросов. | R4 — Medium | План: включить `fastapi-limiter` (Redis) 60 req/min/ключ (quick win). | NFR-DOS-1 | Issue P04-rlimit (open). |
| F4 — Edge → Core hop | Spoofing / Repudiation | Обход логирования, вставка запросов минуя ingress. | R5 — Medium | mTLS между ingress и app, обязательный `X-Trace-Id`, аудиты на каждом мутирующем методе. | NFR-AU-1 | ASGI middleware (planned). |
| F5 — API ↔ DB | Tampering | Прямая запись в БД в обход владельца/валидации. | R5 — Medium | Все DAO операции идут через сервисный слой, owner/user existence проверяется, каскадное удаление назначений. | NFR-VAL-1, NFR-SC-1 | `app/main.py:413-552`, tests `test_chore_crud_flow`. |
| F6 — `/stats` ответы | Information Disclosure | Раскрытие приватных метрик (кол-во людей дома). | R6 — Medium | Статы доступны только по API ключу, отдаём агрегаты без PII, ошибки → RFC7807. | NFR-SC-1, NFR-R-1 | `app/main.py:529-552`, `tests/test_assignments_and_stats_flow`. |
| F7 — Outbound notifications | Spoofing / DoS / Info disclosure | SSRF через произвольные URL или зависание на медленных ответах. | R7 — High | План: allowlist доменов + 2s таймаут + очередь с DLQ перед включением реальных уведомлений. | NFR-COM-1 | Risk R7, infra ticket SEC-27 (quick win once queue ready). |
| F8 — Callback → API | Spoofing / Repudiation | Поддельные статусы помечают задания выполненными. | R8 — High | План: принимать callbacks только из внутреннего CIDR + подпись shared secret, логировать с correlation_id. | NFR-COM-1, NFR-AU-1 | Risk R8, design doc WIP. |
| F9 — Observability logs | Information Disclosure | Случайная запись PII или API ключа в логи. | R10 — Medium | Структурные логи с whitelist полей, scrubber middleware, доступ read-only. | NFR-LOG-1, NFR-AU-1 | Logging checklist, tests (TODO). |
| F10 — Support dashboards | Elevation / Information Disclosure | Компрометация учётки поддержки → доступ к операционке. | R6 — Medium | SSO + least privilege (read-only), audit trail каждой сессии. | NFR-AU-1 | Okta policy (out of scope). |
| F11/F12 — CI/CD pipeline | Tampering / Elevation | Supply-chain атака через GitHub Actions или registry → деплой вредоносного образа. | R9 — High | Signed containers (cosign), OIDC для push, CI job запускает SAST/pytest/ruff перед деплоем. | NFR-SDLC-1 | `.github/workflows/ci.yml`, cosign plan. |
| F7a/F9a — Manual fallback list | Repudiation | Потеря следов при ручной обработке неуспешных уведомлений. | R8 — High | Список ведётся в том же журнале с `correlation_id`; поддержка подписывает завершение. | NFR-AU-1 | SOP #notif-fallback. |

> Потоки F7/F8/F7a зависят от включения настоящих уведомлений; до того момента endpoint закрыт флагом, что фиксируется в рисках R7–R8.
